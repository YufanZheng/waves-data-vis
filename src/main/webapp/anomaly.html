<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Index page of waves data vis">
    <meta name="author" content="Yufan Zheng">

    <title>Waves Vis</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">

</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
  <a class="navbar-brand" href="/data-vis">Waves Platform</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarsExampleDefault">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <a class="nav-link" href="/data-vis/observation.html">Observation</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/data-vis/flags.html">Flags</a>
      </li>
      <li class="nav-item active">
        <a class="nav-link" href="/data-vis/anomaly.html">Anomalies</a>
      </li>
    </ul>
    <form class="form-inline my-2 my-lg-0">
      <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
      <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
    </form>
  </div>
</nav>
<!-- End of Navbar -->

<!-- Main Content -->
<main role="main">
<div class="container-fluid" style="margin-top:56px">
  <div class="row justify-content-between">
  <!-- Left Side --> 
  <div class="col-md-9">
  <!-- Main Vis Panel -->
  <div id="panel" style="margin-top:20px"></div>
  <!-- End of Panel -->
  <!-- Data Table -->
  <p class="text-center" style="padding:10px">Anomaly Table</p>
  <table class="table" id="table">
    <thead class="thead-light">
      <tr>
        <th scope="col">Sector</th>
        <th scope="col">Start Time</th>
        <th scope="col">End Time</th>
        <th scope="col">Weight</th>
      </tr>
    </thead>
    <tbody style="max-height:400px;overflow:scroll">
    </tbody>
  </table> 
  <!-- End of Table -->
  </div> 
  <!-- End of Left Side --> 
  <!-- Right Side -->
  <div class="col-md-3 hiddex-sm">
    <p style="padding:5px"></p>
    <button type="button" class="btn btn-success btn-block" id="getAnomaly">Receiving Anomaly Data</button>
    <p style="padding:5px"></p>
    <!-- Sector Selector -->
    <div class="card" style="width:100%; margin-top:10px" id="sectors">
      <div class="card-header">
        Sectors
      </div>
      <ul class="list-group list-group-flush" style="max-height:630px; overflow:scroll;">
      </ul>
    </div>
    <!-- End of Sector Selector -->
  </div>
  <!-- End of Right Side -->
  </div>
</div>
</main>
<!-- End of Main Content -->

<!-- jQuery js -->
<script src="js/jquery.min.js"></script>
<!-- popper js -->
<script src="js/popper.min.js"></script>
<!-- bootstrap js -->
<script src="js/bootstrap.min.js"></script>

<!-- Highchart js -->
<script src="js/highstock.min.js"></script>
<script src="js/exporting.min.js"></script>

<script>

// ---------------------------------
// Global Variable:
//   All Charts Dictionary
//   sector_name -> chart mappings
// ---------------------------------

// - key  : Sector name :
//          the name will be used asid of the chart panel
// - value: Corresponding chart
var charts = {};

// List of sector names
var sectors = [];
    
// Google Map Geocoder, used to find the latitude and longitude of sector
var geocoder;
    
// Callback function of google map js api to init global variable geocoder
function initGeocoder() {
    geocoder = new google.maps.Geocoder();
    getLocation("Nanterre Sud");
}
    
function getLocation(sector){
    var address = sector + " France";
    geocoder.geocode( { 'address': address}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
            var latitude = results[0].geometry.location.lat();
            var longitude = results[0].geometry.location.lng();
            console.log(latitude, longitude);
        } 
    }); 
}

// ---------------------------------
// Get all sectors
// ---------------------------------   

$(document).ready(function(){
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/data-vis/webapi/context", true);
    xhr.onreadystatechange = (event) => {
      if (xhr.readyState == XMLHttpRequest.DONE) {
          // Step 1: Parse json
          var json = JSON.parse(xhr.responseText);
          var graphs = json["@graph"];
          // Fetch the list of sector names
          for(var i = 0; i < graphs.length; i++){
              var graph = graphs[i];
              if( graph["@type"] == "http://purl.oclc.org/NET/ssnx/ssn#Platform" ){
                  var sector = graph["rdfs:label"];
                  sectors.push(sector);
              }
          }
          // Step 2: Append list of sectors to right side selector
          for(var i = 0; i < sectors.length; i++){
              var sector = sectors[i];
              var $newListItem = $('<li class="list-group-item"><input type="checkbox" name="sector" value="'+sector+'"> '+sector+'</li>');
              $("#sectors ul").append($newListItem);
          }
          // Step 3: Show one chart to remedy the vacancy
          var $firstSectorCheckbox = $("#sectors ul li input").first();
          $firstSectorCheckbox.prop( "checked", true );
          var sector = $firstSectorCheckbox.val();
          var chart = createChart(sector);
          charts[sector] = chart;
      }
    }
    xhr.send();
});
    
function parseLabelToAddress(label){
    //
    // Why need to parse sector label to address?
    //
    // For some sector name given in contect.json file, 
    //   i.e. "SECTEUR 10 - Buzenval 3ème Elévation"
    // If we give their name directly to google map api, 
    //   it can not get the longitude and latitude
    //
    // This function is to parse the label to an address
    //   that could be processed by google map api
    //
    if( label.startsWith("SECTEUR") ){
        // "SECTEUR 01 - Villeneuve"              -> "Villeneuve"
        // "SECTEUR 10 - Buzenval 3ème Elévation" -> "Buzenval 3ème Elévation"
        label = label.split(" - ")[1];
        if( label.endsWith("3ème Elévation") ){
            // "Buzenval 3ème Elévation"    -> "Buzenval"
            // "Mt Valérien 3éme Elevation" -> "Mt Valérien"
            label = label.replace(" 3ème Elévation", "");
        }
    }
    return label;
}
    
// ---------------------------------
// Add / Remove Charts
// ---------------------------------   
    
$('div#sectors').on('change', ':checkbox', function(){
    // When user select/de-seclect a sector to view
    var sector = $(this).val();
    if( $(this).prop('checked') ){
        // Show the chart
        var chart = createChart(sector);
        charts[sector] = chart;
    } else {
        // Remove the chart
        removeChart(sector);
        delete charts[sector];
    }

});

// ---------------------------------
// Highchart Global Settings
// ---------------------------------
    
Highcharts.setOptions({
    global: {
        useUTC: false
    }
});

// ---------------------------------
// Create a Chart
// ---------------------------------

// @Params:
//   - name: name of the sector,
//           the name will also be setted as the chart id
// @Returns:
//   - Created Chart Object
function createChart(name){
    
    // Create the chart node
    var $chartNode = $('<div></div>');
    $chartNode.attr('id', name);
    $('#panel').append($chartNode);
    
    // Init node with highcharts
    var chart = Highcharts.stockChart(name, {
        chart: {
            events: {
                load: function () {
                    var series = this.series[0];
                }
            }
        },
        title: {
            text: 'Anomaly Detection - ' + name
        },
        series: [{
            name: name,
            data: (function () {
                // generate an array of 0 data for
                var data = [],
                    time = (new Date()).getTime(),
                    i,
                    j;
                for (i = -999; i <= 0; i += 1) {
                    data.push([
                        time + i * 1000,
                        0,
                        1
                    ]);
                }
                return data;
            }())
        }],
        yAxis: {
            title: {
                text: 'Weights'
            }
        },
        rangeSelector: {
            buttons: [{
                count: 1,
                type: 'minute',
                text: '1M'
            }, {
                count: 5,
                type: 'minute',
                text: '5M'
            }, {
                type: 'all',
                text: 'All'
            }],
            inputEnabled: false,
            selected: 0
        }
    });   
    
    return chart;
}
    
function removeChart(name) {
    $('#'+name).remove();
}

// ---------------------------------
// Append a point to chart
// ---------------------------------

// @Params:
//   - chart: chart to add point
//   - y    : point's y axis
function addPoint(chart, y){
    var x = (new Date()).getTime();
    chart.series[0].addPoint([x, y], true, true);
}

// ---------------------------------
// Recieve Data From Back-End
// ---------------------------------

// When user click on button "Start Receiving Data"
//  - 1. Get the formatted json data and parse it
//  - 2. Fetch the sector and anomaly information
//       Append the data to table below
//  - 3. Add points for each chart
//    - 3.1. If this sector has anomaly, append point with weight as y axis
//    - 3.2. If no anomaly in this sector, append point with 0 as y axis
//
$("button#getAnomaly").click(function(e){
    e.preventDefault();
    
    setInterval(function(){
        // Every 1 second, send request to get the anomaly data
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/data-vis/webapi/anomaly", true);
        xhr.onreadystatechange = (event) => {
          if (xhr.readyState == XMLHttpRequest.DONE) {
              
              // Step 1: Parse json
              var json = JSON.parse(xhr.responseText);
              var head = json['head'];
              var results = json['results'];
              var bindings = results['bindings'];
              
              // Step 2: From bindings fetch anomalies
              // sector -> weight mappings
              var anomalies = {};
              // From each data bindings result fetch data
              for(var i = 0; i < bindings.length; i++){
                var data = bindings[i];
                // Get all 4 informations
                var sector = data['sector']['value'].replace('http://waves-rsp.org/resource#', '');
                var startTime = data['startTime']['value'];
                var endTime = data['endTime']['value'];
                var weight = data['weight']['value'];
                // Set weight for sector
                anomalies[sector] = weight;
                // Append to table
                appendToTable(sector, startTime, endTime, weight);
              }
              
              // Step 3: Vis on charts 
              // Iterate each sector chart to append new point
              for(var sector in charts) {
                // Get the chart for sector
                var chart = charts[sector];
                // If in this sector, we detect the anomaly
                if(sector in anomalies){
                  // Append a point with the weight value as y axis 
                  var weight = anomalies[sector];
                  addPoint(chart, parseFloat(weight));    
                } else {
                  // If no anomaly detected, append 0
                  addPoint(chart, 0);
                }
              }
          }
        }
        xhr.send();
    }, 1000);
    
});

// ---------------------------------
// Append Data to Table
// ---------------------------------
    
function appendToTable(sector, startTime, endTime, weight){
    var $row = $(`
      <tr>
        <td>` + sector + `</td>
        <td>` + startTime +`</td>
        <td>` + endTime + `</td>
        <td>` + weight + `</td>
      </tr>
    `);
    $('table#table tbody').append($row);
}
    
</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwoT7iVUJfFq0-owyD2nvK-m5dZ26FawY&callback=initGeocoder">
</script>
</body>
</html>
