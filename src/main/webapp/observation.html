<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Index page of waves data vis">
    <meta name="author" content="Yufan Zheng">

    <title>Waves Vis</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css">

</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
  <a class="navbar-brand" href="/data-vis">Waves Platform</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarsExampleDefault">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item active">
        <a class="nav-link" href="/data-vis/observation.html">Observation</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/data-vis/flags.html">Flags</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/data-vis/anomaly.html">Anomalies</a>
      </li>
    </ul>
    <form class="form-inline my-2 my-lg-0">
      <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
      <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
    </form>
  </div>
</nav>
<!-- End of Navbar -->

<!-- Main Vis Panel -->
<main role="main">
<div class="container-fluid" style="margin-top:36px">
  <div class="row">
    <!-- Left Side -->
    <div class="col-sm-9">
      <br><br><br>
      <!-- Map -->
      <div id="map" style="height:460px">Loading Map...</div>
      <!-- End of Map -->
      <br>
      <button class="btn btn-lg btn-light" type="button" id="receiveObs">Receive Sensor Observation</button>
    </div>
    <!-- End of Left Side -->
    <!-- Right Side -->
    <div class="col-sm-3">
    <!-- Sensors Selector -->
    <div class="card" style="width:100%; margin-top:60px">
      <div class="card-header">
        Sensors
      </div>
      <ul class="list-group list-group-flush" style="max-height:300px; overflow:scroll;" id="sensors">
        <li class="list-group-item"><input type="checkbox" name="sector" value="Q 400G"> Q 400G</li>
        <li class="list-group-item"><input type="checkbox" name="sector" value="PRef Hubies Hauts"> PRef Hubies Hauts</li>
        <li class="list-group-item"><input type="checkbox" name="sector" value="QE HC2"> QE HC2</li>
      </ul>
    </div>
    <!-- End of Sensor Selector -->
    <br>
    <button class="btn btn-success btn-block" data-toggle="modal" data-target="#addSensorModal">Add Observation Sensor</button>
    </div>
    <!-- End of Right Side -->
  </div>
</div>
</main>
<!-- End of Panel -->

<!-- Modal -->
<div class="modal fade" id="addSensorModal" tabindex="-1">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Choose a Sensor</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="recipient-name" class="col-form-label">Sensor:</label>
              <select class="form-control" id="sensorToAdd">
              </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="addSensor">Add</button>
      </div>
    </div>
  </div>
</div>

<!-- jQuery js -->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
<!-- popper js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"></script>
<!-- bootstrap js -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>

<script>

// ---------------------------------
// Vis Related Global Variable
// ---------------------------------

var api;                     // Google Map Chart API
var map;                     // Map to draw circles
var circles = {};            // sensor_name -> circle mappings
var sensors = [];            // Sensors and location related information
    
// ---------------------------------
// Get sensor location related info
// ---------------------------------
    
$(document).ready(function(){
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/data-vis/webapi/context", true);
    xhr.onreadystatechange = (event) => {
      if (xhr.readyState == XMLHttpRequest.DONE) {
          // Step 1: Parse json
          var json = JSON.parse(xhr.responseText);
          var graphs = json['@graph'];
      	  for( var i = 0; i < graphs.length; i++ ){
      		  var obj = graphs[i];
      		  var type = obj['@type'];
      		  if( type == 'http://purl.oclc.org/NET/ssnx/ssn#Sensor' ){
      			  var name = obj['rdfs:label'];
      			  var latitude = obj['http://www.w3.org/2003/01/geo/wgs84_pos#lat']['@value'];
      			  var longitude = obj['http://www.w3.org/2003/01/geo/wgs84_pos#long']['@value'];
      			  var id = obj['@id'];
      			  var sensor = {}
      			  sensor['name'] = name;
      			  sensor['latitude'] = latitude;
      			  sensor['longitude'] = longitude;
      			  sensor['id'] = id;
      			  sensor['observation'] = 0;
      			  sensors.push(sensor);
      		  }
      	  }
      	  for( var i = 0; i < sensors.length; i++ ){
      		  var name = sensors[i]['name'];
      		  var $sensorOption = $('<option value="'+name+'">'+name+'</option>');
      		  $('select#sensorToAdd').append($sensorOption);
      	  }
      }
    }
    xhr.send();
});
    
// ---------------------------------
// Create Google Map
// ---------------------------------
    
function initMap() {
    api = google.maps;
    // Create the map.
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: {lat: 4.8851827E1, lng: 2.110242E0},
        mapTypeId: 'terrain'
    });
}

function getSensorByName(name){
	for( var i = 0; i < sensors.length; i++ ){
		if( sensors[i]['name'] == name ){
			return sensors[i];
		}
	}
}

function getSensorById(id){
	for( var i = 0; i < sensors.length; i++ ){
		if( sensors[i]['id'] == id ){
			return sensors[i];
		}
	}
}

function setSensorObsByName(name, value){
	for( var i = 0; i < sensors.length; i++ ){
		if( sensors[i]['name'] == name ){
			return sensors[i]['observation'] = value;
		}
	}
}

function getSensorObsByName(name, value){
	for( var i = 0; i < sensors.length; i++ ){
		if( sensors[i]['name'] == name ){
			return sensors[i]['observation'];
		}
	}
}
    
// ---------------------------------
// Add/Remove Circle to/from Map
// ---------------------------------
  
$('ul#sensors').on('change', ':checkbox', function(){
    
    var name = $(this).val();
    if( $(this).prop('checked') ){
    	var sensor = getSensorByName(name);
    	var latitude = Number(sensor['latitude']);
    	var longitude = Number(sensor['longitude']);
    	console.log("Plot sensor " + name + ", long: " + longitude + ", lat: " + latitude);
        var circle = addSensorToMap(latitude, longitude, name);
        circles[name] = circle;
    } else {
        removeSensorFromMap(name);
        delete circles[name];
    }

});
    
function addSensorToMap(lat, lng, name){
	var color = getRandomColor();
    var circle = new api.Circle({
        strokeColor: color,
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: color,
        fillOpacity: 0.35,
        title:name,
        map: map,
        center: {lat: lat, lng: lng},
        radius: 500
    });
    // Hover circle to see the sensor name
    api.event.addListener(circle,'mouseover',function(){
    	var sensorName = this.get('title');
    	var sensorObs  = getSensorObsByName(sensorName);
        this.getMap().getDiv().setAttribute('title', sensorName + ' : ' + sensorObs);
    });
    api.event.addListener(circle,'mouseout',function(){
        this.getMap().getDiv().removeAttribute('title');
    });
    circles[name] = circle;
    return circle;
}
    
function removeSensorFromMap(sensor){
    var circle = circles[sensor];
    circle.setMap(null);
    delete circles[sensor];
}
    
// ---------------------------------
// Set circle radius
// ---------------------------------
    
function setCircleRadius(circle, radius){
    circle.setRadius(radius);
}

// ---------------------------------
// Click to start receiving data
// ---------------------------------
    
$('button#receiveObs').click(function(){
    setInterval(function(){
        // Every 1 second, send request to get the obeservation values
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/data-vis/webapi/observation", true);
        xhr.onreadystatechange = (event) => {
          if (xhr.readyState == XMLHttpRequest.DONE) {
              // Step 1: Parse json
              var json = JSON.parse(xhr.responseText);
              // Step 2: Fetch the observation value
              var observations = {};
              for( var i = 0; i < json.length; i++ ){
            	  var obs = json[i];
            	  var value = obs['@graph'][0]['qudt:numericValue']['@value'];
            	  var sensorId = obs['@graph'][1]['ssn:isProducedBy']['@id'];
            	  var sensor = getSensorById(sensorId);
            	  var sensorName = sensor['name'];
            	  setSensorObsByName(sensorName, value);
            	  observations[sensorName] = value;
              }
              // Step 3: for each plotted circle
              // 	update their radius with observation value
              for( var name in circles ){
            	  console.log("Sensor " + name + " observation: " + observations[name]);
            	  var circle = circles[name];
            	  if( name in observations ){
            		  var radius = parseFloat(observations[name]) * 10;
            		  setCircleRadius(circle, radius);
            	  }
              }
          }
        }
        xhr.send();
    }, 1000);
});

// ---------------------------------
// Add Sensor to List
// ---------------------------------    

$('button#addSensor').click(function(){
    var sensor = $('#sensorToAdd').val();
    addSensor(sensor);
    $(this).closest('.modal').modal('hide');
});
    
function addSensor(sensor) {
    var $sensorNode = $(`
        <li class="list-group-item"><input type="checkbox" name="sector" value="`+sensor+`"> `+sensor+`</li>
    `);
    var existingSensors = $('#sensors li').text().split(' ');
    if( !(existingSensors.includes(sensor)) ){
      $('#sensors').append($sensorNode);    
    }
}
    
// ---------------------------------
// Random pick color
// ---------------------------------    
    
function getRandomColor() {
  var letters = '0123456789ABCDEF';
  var color = '#';
  for (var i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}
    

</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwoT7iVUJfFq0-owyD2nvK-m5dZ26FawY&callback=initMap">
</script>

</body>
</html>
